<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      @apply bg-gray-100 dark:bg-gray-900 font-sans;
      font-family: 'Inter', sans-serif;
    }
    .msg-user { @apply bg-blue-100 dark:bg-blue-900 text-gray-800 dark:text-white rounded-lg px-4 py-2 max-w-xs ml-auto; }
    .msg-admin { @apply bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-4 py-2 max-w-xs mr-auto; }
    .chat-box { @apply h-64 overflow-y-auto p-3 space-y-3; }
    .user-item { @apply p-3 bg-white dark:bg-gray-700 rounded-lg shadow hover:shadow-md cursor-pointer border border-gray-200 dark:border-gray-600 transition-all; }
  </style>
</head>
<body class="p-6">
  <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
    <div class="p-4 bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
      <h1 class="text-xl font-bold text-center text-gray-800 dark:text-white">ðŸ’¬ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ú†Øª</h1>
    </div>

    <div class="flex h-96">
      <!-- Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
      <div class="w-1/3 bg-gray-50 dark:bg-gray-700 border-r dark:border-gray-600 p-3 overflow-y-auto" id="chatList">
        <p class="text-center text-gray-500 dark:text-gray-400 text-sm">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
      </div>

      <!-- Ø¨Ø®Ø´ Ù¾Ø§Ø³Ø® -->
      <div class="w-2/3 flex flex-col">
        <div class="p-4" id="replySection">
          <h3 id="replyTo" class="font-semibold text-gray-800 dark:text-white"></h3>
          <div id="userChat" class="chat-box border-b pb-2 mb-2"></div>
          <textarea
            id="adminReply"
            placeholder="Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."
            class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
            rows="3"
          ></textarea>
          <button
            onclick="sendReply()"
            class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
          >
            Ø§Ø±Ø³Ø§Ù„
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io('https://chat-backend-3xpu.onrender.com', {
      auth: { isAdmin: true, password: localStorage.getItem('adminPassword') || 'default' }
    });

    let selectedSessionId = null;

    socket.on('connect', () => {
      console.log('âœ… Ø§Ø¯Ù…ÛŒÙ† Ù…ØªØµÙ„ Ø´Ø¯');
    });

    socket.on('admin_recent_chats', (chats) => {
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = '';
      if (chats.length === 0) {
        chatList.innerHTML = '<p class="text-center text-gray-500">Ú†ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>';
        return;
      }
      chats.forEach(chat => {
        const el = document.createElement('div');
        el.className = 'user-item';
        el.innerHTML = `
          <div class="flex justify-between text-sm text-gray-500">
            <span>${chat.name}</span>
            <span>${new Date(chat.timestamp).toLocaleTimeString()}</span>
          </div>
          <p class="mt-1 text-gray-800 dark:text-gray-200 truncate">${chat.lastMessage}</p>
        `;
        el.onclick = () => openChat(chat.sessionId, chat.name, chat.email);
        chatList.appendChild(el);
      });
    });

    socket.on('admin_new_message', (data) => {
      const chatList = document.getElementById('chatList');
      const el = document.createElement('div');
      el.className = 'user-item border-l-4 border-l-blue-500';
      el.innerHTML = `
        <div class="flex justify-between text-sm text-gray-500">
          <span>${data.name}</span>
          <span>${new Date(data.timestamp).toLocaleTimeString()}</span>
        </div>
        <p class="mt-1 text-gray-800 dark:text-gray-200 truncate">${data.text}</p>
      `;
      el.onclick = () => openChat(data.sessionId, data.name, data.email);
      chatList.prepend(el);
    });

    function openChat(sessionId, name, email) {
      selectedSessionId = sessionId;
      document.getElementById('replyTo').textContent = `Ù¾Ø§Ø³Ø® Ø¨Ù‡: ${name}`;
      document.getElementById('userChat').innerHTML = '';
      document.getElementById('adminReply').value = '';
      document.getElementById('replySection').style.display = 'block';
    }

    function sendReply() {
      const reply = document.getElementById('adminReply').value.trim();
      if (!reply || !selectedSessionId) return;
      socket.emit('admin_reply', { sessionId: selectedSessionId, text: reply });
      const userChat = document.getElementById('userChat');
      const msg = document.createElement('div');
      msg.className = 'msg-admin';
      msg.textContent = reply;
      userChat.appendChild(msg);
      document.getElementById('adminReply').value = '';
    }
  </script>
</body>
</html>